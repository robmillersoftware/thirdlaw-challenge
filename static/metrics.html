<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>PDF Scanner - Performance Metrics</title>
    <script src="https://cdn.jsdelivr.net/npm/chart.js"></script>
    <style>
        body {
            font-family: 'Segoe UI', Tahoma, Geneva, Verdana, sans-serif;
            margin: 0;
            padding: 20px;
            background-color: #f5f7fa;
            color: #333;
        }
        .header {
            background: linear-gradient(135deg, #667eea 0%, #764ba2 100%);
            color: white;
            padding: 20px;
            border-radius: 10px;
            margin-bottom: 20px;
            text-align: center;
        }
        .header h1 {
            margin: 0 0 10px 0;
            font-size: 2.5em;
        }
        .header p {
            margin: 0;
            opacity: 0.9;
            font-size: 1.1em;
        }
        .dashboard {
            display: grid;
            grid-template-columns: repeat(auto-fit, minmax(300px, 1fr));
            gap: 20px;
            margin-bottom: 20px;
        }
        .metric-card {
            background: white;
            border-radius: 10px;
            padding: 20px;
            box-shadow: 0 4px 6px rgba(0, 0, 0, 0.1);
            border-left: 4px solid #667eea;
        }
        .metric-card h3 {
            margin: 0 0 15px 0;
            color: #2d3748;
            font-size: 1.2em;
        }
        .metric-value {
            font-size: 2em;
            font-weight: bold;
            color: #667eea;
            margin-bottom: 5px;
        }
        .metric-label {
            color: #718096;
            font-size: 0.9em;
        }
        .health-status {
            display: flex;
            align-items: center;
            gap: 10px;
            margin-bottom: 15px;
        }
        .status-indicator {
            width: 12px;
            height: 12px;
            border-radius: 50%;
        }
        .status-healthy { background-color: #48bb78; }
        .status-warning { background-color: #ed8936; }
        .status-critical { background-color: #f56565; }
        .status-unknown { background-color: #a0aec0; }
        .progress-bar {
            width: 100%;
            height: 8px;
            background-color: #edf2f7;
            border-radius: 4px;
            overflow: hidden;
            margin-top: 10px;
        }
        .progress-fill {
            height: 100%;
            background: linear-gradient(90deg, #48bb78, #38a169);
            transition: width 0.3s ease;
        }
        .insights-section {
            background: white;
            border-radius: 10px;
            padding: 20px;
            box-shadow: 0 4px 6px rgba(0, 0, 0, 0.1);
            margin-bottom: 20px;
        }
        .insights-section h3 {
            margin: 0 0 15px 0;
            color: #2d3748;
        }
        .bottleneck {
            background: #fed7d7;
            color: #c53030;
            padding: 8px 12px;
            border-radius: 5px;
            margin: 5px 0;
            display: inline-block;
        }
        .recommendation {
            background: #c6f6d5;
            color: #2f855a;
            padding: 8px 12px;
            border-radius: 5px;
            margin: 5px 0;
            display: block;
        }
        .controls {
            background: white;
            border-radius: 10px;
            padding: 20px;
            box-shadow: 0 4px 6px rgba(0, 0, 0, 0.1);
            margin-bottom: 20px;
            text-align: center;
        }
        .controls button {
            background: #667eea;
            color: white;
            border: none;
            padding: 10px 20px;
            border-radius: 5px;
            cursor: pointer;
            margin: 0 10px;
            font-size: 16px;
        }
        .controls button:hover {
            background: #5a67d8;
        }
        .controls select {
            padding: 8px 12px;
            border-radius: 5px;
            border: 1px solid #e2e8f0;
            margin: 0 10px;
        }
        .error-list ul {
            list-style: none;
            padding: 0;
        }
        .error-list li {
            background: #fed7d7;
            color: #c53030;
            padding: 8px 12px;
            border-radius: 5px;
            margin: 5px 0;
            display: flex;
            justify-content: space-between;
        }
        .loading {
            text-align: center;
            padding: 40px;
            color: #718096;
        }
        .timestamp {
            text-align: center;
            color: #718096;
            font-size: 0.9em;
            margin-top: 20px;
        }
        .chart-container {
            background: white;
            border-radius: 10px;
            padding: 20px;
            box-shadow: 0 4px 6px rgba(0, 0, 0, 0.1);
            margin-bottom: 20px;
        }
        .chart-container h3 {
            margin: 0 0 15px 0;
            color: #2d3748;
            text-align: center;
        }
        .chart-wrapper {
            position: relative;
            height: 300px;
            margin-bottom: 20px;
        }
        .charts-grid {
            display: grid;
            grid-template-columns: repeat(auto-fit, minmax(400px, 1fr));
            gap: 20px;
            margin-bottom: 20px;
        }
        @media (max-width: 768px) {
            .dashboard {
                grid-template-columns: 1fr;
            }
            .header h1 {
                font-size: 2em;
            }
        }
    </style>
</head>
<body>
    <div class="header">
        <h1>üìä Performance Metrics Dashboard</h1>
        <p>Real-time monitoring for PDF Scanner & Redactor</p>
    </div>

    <div class="controls">
        <label>Time Window:</label>
        <select id="timeWindow" onchange="updateMetrics()">
            <option value="5">Last 5 minutes</option>
            <option value="15">Last 15 minutes</option>
            <option value="60" selected>Last hour</option>
            <option value="360">Last 6 hours</option>
            <option value="1440">Last 24 hours</option>
        </select>
        <button onclick="updateMetrics()">üîÑ Refresh</button>
        <button onclick="toggleAutoRefresh()">‚è∞ Auto Refresh: <span id="autoRefreshStatus">ON</span></button>
    </div>

    <div id="loadingIndicator" class="loading">
        <p>Loading metrics...</p>
    </div>

    <div id="metricsContainer" style="display: none;">
        <!-- Health Status -->
        <div class="insights-section">
            <h3>üè• System Health</h3>
            <div class="health-status">
                <div id="healthIndicator" class="status-indicator status-unknown"></div>
                <span id="healthStatus">Unknown</span>
                <span id="performanceScore" style="margin-left: auto; font-weight: bold;"></span>
            </div>
            <div id="uptime"></div>
        </div>

        <!-- Real-time Charts -->
        <div class="charts-grid">
            <div class="chart-container">
                <h3>üìà Throughput (Requests/Minute)</h3>
                <div class="chart-wrapper">
                    <canvas id="throughputChart"></canvas>
                </div>
            </div>
            
            <div class="chart-container">
                <h3>üíæ System Resources</h3>
                <div class="chart-wrapper">
                    <canvas id="resourcesChart"></canvas>
                </div>
            </div>
        </div>

        <div class="charts-grid">
            <div class="chart-container">
                <h3>‚è±Ô∏è Processing Time Trends</h3>
                <div class="chart-wrapper">
                    <canvas id="processingChart"></canvas>
                </div>
            </div>
            
            <div class="chart-container">
                <h3>üóÑÔ∏è Database Health</h3>
                <div class="chart-wrapper">
                    <canvas id="databaseChart"></canvas>
                </div>
            </div>
        </div>

        <!-- Key Metrics Dashboard -->
        <div class="dashboard">
            <div class="metric-card">
                <h3>üöÄ Throughput</h3>
                <div class="metric-value" id="documentsPerHour">-</div>
                <div class="metric-label">Documents per hour</div>
                <div class="metric-value" style="font-size: 1.5em; margin-top: 10px;" id="requestsPerMinute">-</div>
                <div class="metric-label">Requests per minute</div>
            </div>

            <div class="metric-card">
                <h3>‚ö° Performance</h3>
                <div class="metric-value" id="avgProcessingTime">-</div>
                <div class="metric-label">Avg processing time (ms)</div>
                <div style="display: flex; justify-content: space-between; margin-top: 10px;">
                    <div>
                        <div style="font-weight: bold;" id="p95ProcessingTime">-</div>
                        <div class="metric-label">95th percentile</div>
                    </div>
                    <div>
                        <div style="font-weight: bold;" id="p99ProcessingTime">-</div>
                        <div class="metric-label">99th percentile</div>
                    </div>
                </div>
            </div>

            <div class="metric-card">
                <h3>‚úÖ Success Rate</h3>
                <div class="metric-value" id="successRate">-</div>
                <div class="metric-label">Success percentage</div>
                <div class="progress-bar">
                    <div id="successProgress" class="progress-fill" style="width: 0%"></div>
                </div>
                <div style="margin-top: 10px;">
                    <div style="font-weight: bold;" id="totalProcessed">-</div>
                    <div class="metric-label">Total documents processed</div>
                </div>
            </div>

            <div class="metric-card">
                <h3>üíæ System Resources</h3>
                <div style="margin-bottom: 10px;">
                    <div style="display: flex; justify-content: space-between;">
                        <span>CPU Usage</span>
                        <span id="cpuUsage" style="font-weight: bold;">-%</span>
                    </div>
                    <div class="progress-bar">
                        <div id="cpuProgress" class="progress-fill" style="width: 0%"></div>
                    </div>
                </div>
                <div style="margin-bottom: 10px;">
                    <div style="display: flex; justify-content: space-between;">
                        <span>Memory Usage</span>
                        <span id="memoryUsage" style="font-weight: bold;">-%</span>
                    </div>
                    <div class="progress-bar">
                        <div id="memoryProgress" class="progress-fill" style="width: 0%"></div>
                    </div>
                </div>
                <div>
                    <div style="font-weight: bold;" id="memoryUsedMB">-</div>
                    <div class="metric-label">Memory used (MB)</div>
                </div>
            </div>
        </div>

        <!-- Insights Section -->
        <div class="insights-section">
            <h3>üîç Performance Insights</h3>
            <div id="bottlenecks">
                <h4>‚ö†Ô∏è Bottlenecks:</h4>
                <div id="bottlenecksList"></div>
            </div>
            <div id="recommendations" style="margin-top: 15px;">
                <h4>üí° Recommendations:</h4>
                <div id="recommendationsList"></div>
            </div>
        </div>

        <!-- Errors Section -->
        <div class="insights-section">
            <h3>‚ùå Error Summary</h3>
            <div id="errors" class="error-list">
                <ul id="errorsList"></ul>
            </div>
        </div>
    </div>

    <div class="timestamp">
        Last updated: <span id="lastUpdated">-</span>
    </div>

    <script>
        let autoRefresh = true;
        let refreshInterval;
        
        // Chart instances
        let throughputChart, resourcesChart, processingChart, databaseChart;
        
        // Data storage for charts
        let chartData = {
            throughput: { labels: [], data: [] },
            cpu: { labels: [], data: [] },
            memory: { labels: [], data: [] },
            memoryMB: { labels: [], data: [] },
            processing: { labels: [], avg: [], p95: [], p99: [] },
            database: { labels: [], connections: [], queries: [] }
        };

        function formatNumber(num) {
            if (num === null || num === undefined || isNaN(num)) return '-';
            return num.toLocaleString();
        }

        function formatDuration(seconds) {
            if (!seconds) return '-';
            
            const days = Math.floor(seconds / 86400);
            const hours = Math.floor((seconds % 86400) / 3600);
            const minutes = Math.floor((seconds % 3600) / 60);
            
            if (days > 0) return `${days}d ${hours}h ${minutes}m`;
            if (hours > 0) return `${hours}h ${minutes}m`;
            return `${minutes}m ${Math.floor(seconds % 60)}s`;
        }

        function initializeCharts() {
            const chartOptions = {
                responsive: true,
                maintainAspectRatio: false,
                interaction: { mode: 'index', intersect: false },
                plugins: { legend: { position: 'top' } },
                scales: {
                    x: { display: true, title: { display: true, text: 'Time' } },
                    y: { display: true, beginAtZero: true }
                }
            };

            // Throughput Chart
            throughputChart = new Chart(document.getElementById('throughputChart'), {
                type: 'line',
                data: {
                    labels: [],
                    datasets: [{
                        label: 'Requests/Min',
                        data: [],
                        borderColor: 'rgb(102, 126, 234)',
                        backgroundColor: 'rgba(102, 126, 234, 0.1)',
                        tension: 0.3,
                        fill: true
                    }]
                },
                options: { ...chartOptions, scales: { ...chartOptions.scales, y: { ...chartOptions.scales.y, title: { display: true, text: 'Requests/Minute' } } } }
            });

            // Resources Chart
            resourcesChart = new Chart(document.getElementById('resourcesChart'), {
                type: 'line',
                data: {
                    labels: [],
                    datasets: [
                        {
                            label: 'CPU %',
                            data: [],
                            borderColor: 'rgb(239, 68, 68)',
                            backgroundColor: 'rgba(239, 68, 68, 0.1)',
                            tension: 0.3,
                            yAxisID: 'y'
                        },
                        {
                            label: 'Memory %',
                            data: [],
                            borderColor: 'rgb(59, 130, 246)',
                            backgroundColor: 'rgba(59, 130, 246, 0.1)',
                            tension: 0.3,
                            yAxisID: 'y'
                        },
                        {
                            label: 'Memory MB',
                            data: [],
                            borderColor: 'rgb(34, 197, 94)',
                            backgroundColor: 'rgba(34, 197, 94, 0.1)',
                            tension: 0.3,
                            yAxisID: 'y1'
                        }
                    ]
                },
                options: {
                    ...chartOptions,
                    scales: {
                        x: chartOptions.scales.x,
                        y: { ...chartOptions.scales.y, title: { display: true, text: 'Percentage' }, max: 100 },
                        y1: { type: 'linear', display: true, position: 'right', title: { display: true, text: 'MB' }, grid: { drawOnChartArea: false } }
                    }
                }
            });

            // Processing Time Chart
            processingChart = new Chart(document.getElementById('processingChart'), {
                type: 'line',
                data: {
                    labels: [],
                    datasets: [
                        {
                            label: 'Average (ms)',
                            data: [],
                            borderColor: 'rgb(34, 197, 94)',
                            backgroundColor: 'rgba(34, 197, 94, 0.1)',
                            tension: 0.3
                        },
                        {
                            label: 'P95 (ms)',
                            data: [],
                            borderColor: 'rgb(251, 191, 36)',
                            backgroundColor: 'rgba(251, 191, 36, 0.1)',
                            tension: 0.3
                        },
                        {
                            label: 'P99 (ms)',
                            data: [],
                            borderColor: 'rgb(239, 68, 68)',
                            backgroundColor: 'rgba(239, 68, 68, 0.1)',
                            tension: 0.3
                        }
                    ]
                },
                options: { ...chartOptions, scales: { ...chartOptions.scales, y: { ...chartOptions.scales.y, title: { display: true, text: 'Processing Time (ms)' } } } }
            });

            // Database Health Chart
            databaseChart = new Chart(document.getElementById('databaseChart'), {
                type: 'bar',
                data: {
                    labels: ['Database Status', 'Active Connections', 'Success Rate'],
                    datasets: [{
                        label: 'Health Metrics',
                        data: [0, 0, 0],
                        backgroundColor: [
                            'rgba(34, 197, 94, 0.8)',
                            'rgba(102, 126, 234, 0.8)',
                            'rgba(251, 191, 36, 0.8)'
                        ],
                        borderColor: [
                            'rgba(34, 197, 94, 1)',
                            'rgba(102, 126, 234, 1)',
                            'rgba(251, 191, 36, 1)'
                        ],
                        borderWidth: 1
                    }]
                },
                options: {
                    ...chartOptions,
                    scales: { ...chartOptions.scales, y: { ...chartOptions.scales.y, title: { display: true, text: 'Value' }, max: 100 } }
                }
            });
        }

        function updateChartData(timestamp, throughput, systemMetrics, insights) {
            const timeLabel = new Date(timestamp).toLocaleTimeString();
            const maxDataPoints = 20;

            // Update throughput data
            chartData.throughput.labels.push(timeLabel);
            chartData.throughput.data.push(throughput.requests_per_minute || 0);
            
            if (chartData.throughput.labels.length > maxDataPoints) {
                chartData.throughput.labels.shift();
                chartData.throughput.data.shift();
            }

            // Update system resources data
            if (systemMetrics.latest) {
                chartData.cpu.labels.push(timeLabel);
                chartData.memory.labels.push(timeLabel);
                chartData.memoryMB.labels.push(timeLabel);
                
                chartData.cpu.data.push(systemMetrics.latest.cpu_percent || 0);
                chartData.memory.data.push(systemMetrics.latest.memory_percent || 0);
                chartData.memoryMB.data.push(systemMetrics.latest.memory_used_mb || 0);
                
                if (chartData.cpu.labels.length > maxDataPoints) {
                    chartData.cpu.labels.shift();
                    chartData.memory.labels.shift();
                    chartData.memoryMB.labels.shift();
                    chartData.cpu.data.shift();
                    chartData.memory.data.shift();
                    chartData.memoryMB.data.shift();
                }
            }

            // Update processing time data
            chartData.processing.labels.push(timeLabel);
            chartData.processing.avg.push(throughput.avg_processing_time_ms || 0);
            chartData.processing.p95.push(throughput.p95_processing_time_ms || 0);
            chartData.processing.p99.push(throughput.p99_processing_time_ms || 0);
            
            if (chartData.processing.labels.length > maxDataPoints) {
                chartData.processing.labels.shift();
                chartData.processing.avg.shift();
                chartData.processing.p95.shift();
                chartData.processing.p99.shift();
            }

            // Update charts
            throughputChart.data.labels = [...chartData.throughput.labels];
            throughputChart.data.datasets[0].data = [...chartData.throughput.data];
            throughputChart.update('none');

            resourcesChart.data.labels = [...chartData.cpu.labels];
            resourcesChart.data.datasets[0].data = [...chartData.cpu.data];
            resourcesChart.data.datasets[1].data = [...chartData.memory.data];
            resourcesChart.data.datasets[2].data = [...chartData.memoryMB.data];
            resourcesChart.update('none');

            processingChart.data.labels = [...chartData.processing.labels];
            processingChart.data.datasets[0].data = [...chartData.processing.avg];
            processingChart.data.datasets[1].data = [...chartData.processing.p95];
            processingChart.data.datasets[2].data = [...chartData.processing.p99];
            processingChart.update('none');

            // Update database chart
            const dbConnected = systemMetrics.latest ? 100 : 0;
            const activeConnections = systemMetrics.latest?.active_connections || 0;
            const successRate = throughput.success_rate_percent || 0;
            
            databaseChart.data.datasets[0].data = [dbConnected, activeConnections, successRate];
            databaseChart.update('none');
        }

        async function updateMetrics() {
            const timeWindow = document.getElementById('timeWindow').value;
            document.getElementById('loadingIndicator').style.display = 'block';
            document.getElementById('metricsContainer').style.display = 'none';

            try {
                // Fetch all metrics
                const [metricsResponse, systemResponse, insightsResponse, errorsResponse] = await Promise.all([
                    fetch(`/metrics/throughput?minutes=${timeWindow}`),
                    fetch(`/metrics/system?minutes=${timeWindow}`),
                    fetch(`/metrics/insights?minutes=${timeWindow}`),
                    fetch(`/metrics/errors`)
                ]);

                const throughput = await metricsResponse.json();
                const systemMetrics = await systemResponse.json();
                const insights = await insightsResponse.json();
                const errors = await errorsResponse.json();

                // Update throughput metrics
                document.getElementById('documentsPerHour').textContent = formatNumber(throughput.documents_per_hour);
                document.getElementById('requestsPerMinute').textContent = formatNumber(throughput.requests_per_minute);
                document.getElementById('avgProcessingTime').textContent = formatNumber(throughput.avg_processing_time_ms);
                document.getElementById('p95ProcessingTime').textContent = formatNumber(throughput.p95_processing_time_ms) + 'ms';
                document.getElementById('p99ProcessingTime').textContent = formatNumber(throughput.p99_processing_time_ms) + 'ms';
                document.getElementById('successRate').textContent = throughput.success_rate_percent + '%';
                document.getElementById('totalProcessed').textContent = formatNumber(throughput.total_documents_processed);

                // Update success rate progress bar
                document.getElementById('successProgress').style.width = throughput.success_rate_percent + '%';

                // Update system metrics
                if (systemMetrics.latest) {
                    const latest = systemMetrics.latest;
                    document.getElementById('cpuUsage').textContent = latest.cpu_percent.toFixed(1) + '%';
                    document.getElementById('memoryUsage').textContent = latest.memory_percent.toFixed(1) + '%';
                    document.getElementById('memoryUsedMB').textContent = formatNumber(latest.memory_used_mb.toFixed(1)) + ' MB';
                    
                    // Update progress bars
                    document.getElementById('cpuProgress').style.width = Math.min(100, latest.cpu_percent) + '%';
                    document.getElementById('memoryProgress').style.width = Math.min(100, latest.memory_percent) + '%';
                    
                    // Change progress bar color based on usage
                    const cpuBar = document.getElementById('cpuProgress');
                    const memoryBar = document.getElementById('memoryProgress');
                    
                    cpuBar.style.background = latest.cpu_percent > 80 ? '#f56565' : 
                                            latest.cpu_percent > 60 ? '#ed8936' : '#48bb78';
                    memoryBar.style.background = latest.memory_percent > 80 ? '#f56565' : 
                                                latest.memory_percent > 60 ? '#ed8936' : '#48bb78';
                }

                // Update health status
                const healthStatus = insights.health_status || 'unknown';
                const healthIndicator = document.getElementById('healthIndicator');
                const performanceScore = insights.performance_score || 0;
                
                healthIndicator.className = `status-indicator status-${healthStatus}`;
                document.getElementById('healthStatus').textContent = healthStatus.charAt(0).toUpperCase() + healthStatus.slice(1);
                document.getElementById('performanceScore').textContent = `Performance Score: ${performanceScore}/100`;
                document.getElementById('uptime').textContent = `Uptime: ${formatDuration(insights.uptime_seconds)}`;

                // Update bottlenecks
                const bottlenecksList = document.getElementById('bottlenecksList');
                bottlenecksList.innerHTML = '';
                if (insights.bottlenecks && insights.bottlenecks.length > 0) {
                    insights.bottlenecks.forEach(bottleneck => {
                        const div = document.createElement('div');
                        div.className = 'bottleneck';
                        div.textContent = bottleneck;
                        bottlenecksList.appendChild(div);
                    });
                } else {
                    bottlenecksList.innerHTML = '<span style="color: #48bb78;">‚úÖ No bottlenecks detected</span>';
                }

                // Update recommendations
                const recommendationsList = document.getElementById('recommendationsList');
                recommendationsList.innerHTML = '';
                if (insights.recommendations && insights.recommendations.length > 0) {
                    insights.recommendations.forEach(recommendation => {
                        const div = document.createElement('div');
                        div.className = 'recommendation';
                        div.textContent = recommendation;
                        recommendationsList.appendChild(div);
                    });
                } else {
                    recommendationsList.innerHTML = '<span style="color: #48bb78;">‚úÖ System running optimally</span>';
                }

                // Update errors
                const errorsList = document.getElementById('errorsList');
                errorsList.innerHTML = '';
                if (errors.errors && Object.keys(errors.errors).length > 0) {
                    Object.entries(errors.errors).forEach(([errorType, count]) => {
                        const li = document.createElement('li');
                        li.innerHTML = `<span>${errorType}</span><span>${count} occurrences</span>`;
                        errorsList.appendChild(li);
                    });
                } else {
                    errorsList.innerHTML = '<li style="background: #c6f6d5; color: #2f855a;"><span>‚úÖ No errors recorded</span><span></span></li>';
                }

                document.getElementById('lastUpdated').textContent = new Date().toLocaleString();

                // Update charts with new data
                updateChartData(new Date().getTime(), throughput, systemMetrics, insights);

            } catch (error) {
                console.error('Error fetching metrics:', error);
                document.getElementById('loadingIndicator').innerHTML = '<p style="color: #f56565;">‚ùå Error loading metrics</p>';
            } finally {
                document.getElementById('loadingIndicator').style.display = 'none';
                document.getElementById('metricsContainer').style.display = 'block';
            }
        }

        function toggleAutoRefresh() {
            autoRefresh = !autoRefresh;
            const status = document.getElementById('autoRefreshStatus');
            
            if (autoRefresh) {
                status.textContent = 'ON';
                startAutoRefresh();
            } else {
                status.textContent = 'OFF';
                clearInterval(refreshInterval);
            }
        }

        function startAutoRefresh() {
            clearInterval(refreshInterval);
            if (autoRefresh) {
                refreshInterval = setInterval(updateMetrics, 30000); // Refresh every 30 seconds
            }
        }

        // Initialize
        document.addEventListener('DOMContentLoaded', function() {
            initializeCharts();
            updateMetrics();
            startAutoRefresh();
        });
    </script>
</body>
</html>